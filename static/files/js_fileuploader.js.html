<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/fileuploader.js - WP-Property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="WP-Property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.38.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/wpp.html">wpp</a></li>
            
                <li><a href="../classes/wpp.overview.html">wpp.overview</a></li>
            
                <li><a href="../classes/wpp.xmli.html">wpp.xmli</a></li>
            
                <li><a href="../classes/WPP_RETS.html">WPP_RETS</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: js/fileuploader.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * http://github.com/valums/file-uploader
 *
 * Multiple file upload component with progress-bar, drag-and-drop.
 * Â© 2010 Andrew Valums ( andrew(at)valums.com )
 *
 * Licensed under GNU GPL 2 or later and GNU LGPL 2 or later, see license.txt.
 */

//
// Helper functions
//

var qq = qq || {};

/**
 * Adds all missing properties from second obj to first obj
 */
qq.extend = function(first, second){
    for (var prop in second){
        first[prop] = second[prop];
    }
};

/**
 * Searches for a given element in the array, returns -1 if it is not present.
 * @param {Number} [from] The index at which to begin the search
 */
qq.indexOf = function(arr, elt, from){
    if (arr.indexOf) return arr.indexOf(elt, from);

    from = from || 0;
    var len = arr.length;

    if (from &lt; 0) from += len;

    for (; from &lt; len; from++){
        if (from in arr &amp;&amp; arr[from] === elt){
            return from;
        }
    }
    return -1;
};

qq.getUniqueId = (function(){
    var id = 0;
    return function(){ return id++; };
})();

//
// Events

qq.attach = function(element, type, fn){
    if (element.addEventListener){
        element.addEventListener(type, fn, false);
    } else if (element.attachEvent){
        element.attachEvent(&#x27;on&#x27; + type, fn);
    }
};
qq.detach = function(element, type, fn){
    if (element.removeEventListener){
        element.removeEventListener(type, fn, false);
    } else if (element.attachEvent){
        element.detachEvent(&#x27;on&#x27; + type, fn);
    }
};

qq.preventDefault = function(e){
    if (e.preventDefault){
        e.preventDefault();
    } else{
        e.returnValue = false;
    }
};

//
// Node manipulations

/**
 * Insert node a before node b.
 */
qq.insertBefore = function(a, b){
    b.parentNode.insertBefore(a, b);
};
qq.remove = function(element){
    element.parentNode.removeChild(element);
};

qq.contains = function(parent, descendant){
    // compareposition returns false in this case
    if (parent == descendant) return true;

    if (parent.contains){
        return parent.contains(descendant);
    } else {
        return !!(descendant.compareDocumentPosition(parent) &amp; 8);
    }
};

/**
 * Creates and returns element from html string
 * Uses innerHTML to create an element
 */
qq.toElement = (function(){
    var div = document.createElement(&#x27;div&#x27;);
    return function(html){
        div.innerHTML = html;
        var element = div.firstChild;
        div.removeChild(element);
        return element;
    };
})();

//
// Node properties and attributes

/**
 * Sets styles for an element.
 * Fixes opacity in IE6-8.
 */
qq.css = function(element, styles){
    if (styles.opacity != null){
        if (typeof element.style.opacity != &#x27;string&#x27; &amp;&amp; typeof(element.filters) != &#x27;undefined&#x27;){
            styles.filter = &#x27;alpha(opacity=&#x27; + Math.round(100 * styles.opacity) + &#x27;)&#x27;;
        }
    }
    qq.extend(element.style, styles);
};
qq.hasClass = function(element, name){
    var re = new RegExp(&#x27;(^| )&#x27; + name + &#x27;( |$)&#x27;);
    return re.test(element.className);
};
qq.addClass = function(element, name){
    if (!qq.hasClass(element, name)){
        element.className += &#x27; &#x27; + name;
    }
};
qq.removeClass = function(element, name){
    var re = new RegExp(&#x27;(^| )&#x27; + name + &#x27;( |$)&#x27;);
    element.className = element.className.replace(re, &#x27; &#x27;).replace(/^\s+|\s+$/g, &quot;&quot;);
};
qq.setText = function(element, text){
    jQuery(element).html(text);

};

//
// Selecting elements

qq.children = function(element){
    var children = [],
    child = element.firstChild;

    while (child){
        if (child.nodeType == 1){
            children.push(child);
        }
        child = child.nextSibling;
    }

    return children;
};

qq.getByClass = function(element, className){
    if (element.querySelectorAll){
        return element.querySelectorAll(&#x27;.&#x27; + className);
    }

    var result = [];
    var candidates = element.getElementsByTagName(&quot;*&quot;);
    var len = candidates.length;

    for (var i = 0; i &lt; len; i++){
        if (qq.hasClass(candidates[i], className)){
            result.push(candidates[i]);
        }
    }
    return result;
};

/**
 * obj2url() takes a json-object as argument and generates
 * a querystring. pretty much like jQuery.param()
 *
 * how to use:
 *
 *    &#x60;qq.obj2url({a:&#x27;b&#x27;,c:&#x27;d&#x27;},&#x27;http://any.url/upload?otherParam=value&#x27;);&#x60;
 *
 * will result in:
 *
 *    &#x60;http://any.url/upload?otherParam=value&amp;a=b&amp;c=d&#x60;
 *
 * @param  Object JSON-Object
 * @param  String current querystring-part
 * @return String encoded querystring
 */
qq.obj2url = function(obj, temp, prefixDone){
    var uristrings = [],
        prefix = &#x27;&amp;&#x27;,
        add = function(nextObj, i){
            var nextTemp = temp
                ? (/\[\]$/.test(temp)) // prevent double-encoding
                   ? temp
                   : temp+&#x27;[&#x27;+i+&#x27;]&#x27;
                : i;
            if ((nextTemp != &#x27;undefined&#x27;) &amp;&amp; (i != &#x27;undefined&#x27;)) {
                uristrings.push(
                    (typeof nextObj === &#x27;object&#x27;)
                        ? qq.obj2url(nextObj, nextTemp, true)
                        : (Object.prototype.toString.call(nextObj) === &#x27;[object Function]&#x27;)
                            ? encodeURIComponent(nextTemp) + &#x27;=&#x27; + encodeURIComponent(nextObj())
                            : encodeURIComponent(nextTemp) + &#x27;=&#x27; + encodeURIComponent(nextObj)
                );
            }
        };

    if (!prefixDone &amp;&amp; temp) {
      prefix = (/\?/.test(temp)) ? (/\?$/.test(temp)) ? &#x27;&#x27; : &#x27;&amp;&#x27; : &#x27;?&#x27;;
      uristrings.push(temp);
      uristrings.push(qq.obj2url(obj));
    } else if ((Object.prototype.toString.call(obj) === &#x27;[object Array]&#x27;) &amp;&amp; (typeof obj != &#x27;undefined&#x27;) ) {
        // we wont use a for-in-loop on an array (performance)
        for (var i = 0, len = obj.length; i &lt; len; ++i){
            add(obj[i], i);
        }
    } else if ((typeof obj != &#x27;undefined&#x27;) &amp;&amp; (obj !== null) &amp;&amp; (typeof obj === &quot;object&quot;)){
        // for anything else but a scalar, we will use for-in-loop
        for (var i in obj){
            add(obj[i], i);
        }
    } else {
        uristrings.push(encodeURIComponent(temp) + &#x27;=&#x27; + encodeURIComponent(obj));
    }

    return uristrings.join(prefix)
                     .replace(/^&amp;/, &#x27;&#x27;)
                     .replace(/%20/g, &#x27;+&#x27;);
};

//
//
// Uploader Classes
//
//

var qq = qq || {};

/**
 * Creates upload button, validates upload, but doesn&#x27;t create file list or dd.
 */
qq.FileUploaderBasic = function(o){
    this._options = {
        // set to true to see the server response
        debug: false,
        action: &#x27;/server/upload&#x27;,
        params: {},
        button: null,
        multiple: false,
        maxConnections: 3,
        // validation
        allowedExtensions: [&#x27;jpg&#x27;,&#x27;gif&#x27;,&#x27;png&#x27;],
        sizeLimit: 0,
        minSizeLimit: 0,
        // events
        // return false to cancel submit
        onSubmit: function(id, fileName){},
        onProgress: function(id, fileName, loaded, total){},
        onComplete: function(id, fileName, responseJSON){},
        onCancel: function(id, fileName){},
        // messages
        messages: {
            typeError: &quot;{file} has invalid extension. Only {extensions} are allowed.&quot;,
            sizeError: &quot;{file} is too large, maximum file size is {sizeLimit}.&quot;,
            minSizeError: &quot;{file} is too small, minimum file size is {minSizeLimit}.&quot;,
            emptyError: &quot;{file} is empty, please select files again without it.&quot;,
            onLeave: &quot;The files are being uploaded, if you leave now the upload will be cancelled.&quot;
        },
        showMessage: function(message){
            alert(message);
        }
    };
    qq.extend(this._options, o);

    // number of files being uploaded
    this._filesInProgress = 0;
    this._handler = this._createUploadHandler();

    if (this._options.button){
        this._button = this._createUploadButton(this._options.button);
    }

    this._preventLeaveInProgress();
};

qq.FileUploaderBasic.prototype = {
    setParams: function(params){
        this._options.params = params;
    },
    getInProgress: function(){
        return this._filesInProgress;
    },
    _createUploadButton: function(element){
        var self = this;

        return new qq.UploadButton({
            element: element,
            multiple: this._options.multiple &amp;&amp; qq.UploadHandlerXhr.isSupported(),
            onChange: function(input){
                self._onInputChange(input);
            }
        });
    },
    _createUploadHandler: function(){
        var self = this,
            handlerClass;

        if(qq.UploadHandlerXhr.isSupported()){
            handlerClass = &#x27;UploadHandlerXhr&#x27;;
        } else {
            handlerClass = &#x27;UploadHandlerForm&#x27;;
        }

        var handler = new qq[handlerClass]({
            debug: this._options.debug,
            action: this._options.action,
            maxConnections: this._options.maxConnections,
            onProgress: function(id, fileName, loaded, total){
                self._onProgress(id, fileName, loaded, total);
                self._options.onProgress(id, fileName, loaded, total);
            },
            onComplete: function(id, fileName, result){
                self._onComplete(id, fileName, result);
                self._options.onComplete(id, fileName, result);
            },
            onCancel: function(id, fileName){
                self._onCancel(id, fileName);
                self._options.onCancel(id, fileName);
            }
        });

        return handler;
    },
    _preventLeaveInProgress: function(){
        var self = this;

        qq.attach(window, &#x27;beforeunload&#x27;, function(e){
            if (!self._filesInProgress){return;}

            var e = e || window.event;
            // for ie, ff
            e.returnValue = self._options.messages.onLeave;
            // for webkit
            return self._options.messages.onLeave;
        });
    },
    _onSubmit: function(id, fileName){
        this._filesInProgress++;
    },
    _onProgress: function(id, fileName, loaded, total){
    },
    _onComplete: function(id, fileName, result){
        this._filesInProgress--;
        if (result.error){
            this._options.showMessage(result.error);
        }
    },
    _onCancel: function(id, fileName){
        this._filesInProgress--;
    },
    _onInputChange: function(input){
        if (this._handler instanceof qq.UploadHandlerXhr){
            this._uploadFileList(input.files);
        } else {
            if (this._validateFile(input)){
                this._uploadFile(input);
            }
        }
        this._button.reset();
    },
    _uploadFileList: function(files){
        for (var i=0; i&lt;files.length; i++){
            if ( !this._validateFile(files[i])){
                return;
            }
        }

        for (var i=0; i&lt;files.length; i++){
            this._uploadFile(files[i]);
        }
    },
    _uploadFile: function(fileContainer){
        var id = this._handler.add(fileContainer);
        var fileName = this._handler.getName(id);

        if (this._options.onSubmit(id, fileName) !== false){
            this._onSubmit(id, fileName);
            this._handler.upload(id, this._options.params);
        }
    },
    _validateFile: function(file){
        var name, size;

        if (file.value){
            // it is a file input
            // get input value and remove path to normalize
            name = file.value.replace(/.*(\/|\\)/, &quot;&quot;);
        } else {
            // fix missing properties in Safari
            name = file.fileName != null ? file.fileName : file.name;
            size = file.fileSize != null ? file.fileSize : file.size;
        }

        if (! this._isAllowedExtension(name)){
            this._error(&#x27;typeError&#x27;, name);
            return false;

        } else if (size === 0){
            this._error(&#x27;emptyError&#x27;, name);
            return false;

        } else if (size &amp;&amp; this._options.sizeLimit &amp;&amp; size &gt; this._options.sizeLimit){
            this._error(&#x27;sizeError&#x27;, name);
            return false;

        } else if (size &amp;&amp; size &lt; this._options.minSizeLimit){
            this._error(&#x27;minSizeError&#x27;, name);
            return false;
        }

        return true;
    },
    _error: function(code, fileName){
        var message = this._options.messages[code];
        function r(name, replacement){ message = message.replace(name, replacement); }

        r(&#x27;{file}&#x27;, this._formatFileName(fileName));
        r(&#x27;{extensions}&#x27;, this._options.allowedExtensions.join(&#x27;, &#x27;));
        r(&#x27;{sizeLimit}&#x27;, this._formatSize(this._options.sizeLimit));
        r(&#x27;{minSizeLimit}&#x27;, this._formatSize(this._options.minSizeLimit));

        this._options.showMessage(message);
    },
    _formatFileName: function(name){
        if (name.length &gt; 33){
            name = name.slice(0, 19) + &#x27;...&#x27; + name.slice(-13);
        }
        return name;
    },
    _isAllowedExtension: function(fileName){
        var ext = (-1 !== fileName.indexOf(&#x27;.&#x27;)) ? fileName.replace(/.*[.]/, &#x27;&#x27;).toLowerCase() : &#x27;&#x27;;
        var allowed = this._options.allowedExtensions;

        if (!allowed.length){return true;}

        for (var i=0; i&lt;allowed.length; i++){
            if (allowed[i].toLowerCase() == ext){ return true;}
        }

        return false;
    },
    _formatSize: function(bytes){
        var i = -1;
        do {
            bytes = bytes / 1024;
            i++;
        } while (bytes &gt; 99);

        return Math.max(bytes, 0.1).toFixed(1) + [&#x27;kB&#x27;, &#x27;MB&#x27;, &#x27;GB&#x27;, &#x27;TB&#x27;, &#x27;PB&#x27;, &#x27;EB&#x27;][i];
    }
};


/**
 * Class that creates upload widget with drag-and-drop and file list
 * @inherits qq.FileUploaderBasic
 */
qq.FileUploader = function(o){
    // call parent constructor
    qq.FileUploaderBasic.apply(this, arguments);

    // additional options
    qq.extend(this._options, {
        element: null,
        // if set, will be used instead of qq-upload-list in template
        listElement: null,

        template: &#x27;&lt;div class=&quot;qq-uploader&quot;&gt;&#x27; +
                &#x27;&lt;div class=&quot;qq-upload-drop-area&quot;&gt;&lt;span&gt;&#x27;+wpp.strings.drop_file+&#x27;&lt;/span&gt;&lt;/div&gt;&#x27; +
                &#x27;&lt;div class=&quot;qq-upload-button&quot;&gt;&#x27;+wpp.strings.upload_images+&#x27;&lt;/div&gt;&#x27; +
                &#x27;&lt;ul class=&quot;qq-upload-list&quot;&gt;&lt;/ul&gt;&#x27; +
             &#x27;&lt;/div&gt;&#x27;,

        // template for one item in file list
        fileTemplate: &#x27;&lt;li&gt;&#x27; +
                &#x27;&lt;span class=&quot;qq-upload-file&quot;&gt;&lt;/span&gt;&lt;a class=&quot;qq-upload-cancel&quot; href=&quot;#&quot;&gt;&#x27;+wpp.strings.cancel+&#x27;&lt;/a&gt;&#x27; +
                &#x27;&lt;span class=&quot;qq-upload-spinner&quot;&gt;&lt;/span&gt;&#x27; +
                &#x27;&lt;span class=&quot;qq-upload-size&quot;&gt;&lt;/span&gt;&#x27; +
                &#x27;&lt;span class=&quot;qq-upload-failed-text&quot;&gt;&#x27;+wpp.strings.fail+&#x27;&lt;/span&gt;&#x27; +
            &#x27;&lt;/li&gt;&#x27;,

        classes: {
            // used to get elements from templates
            button: &#x27;qq-upload-button&#x27;,
            drop: &#x27;qq-upload-drop-area&#x27;,
            dropActive: &#x27;qq-upload-drop-area-active&#x27;,
            list: &#x27;qq-upload-list&#x27;,

            file: &#x27;qq-upload-file&#x27;,
            spinner: &#x27;qq-upload-spinner&#x27;,
            size: &#x27;qq-upload-size&#x27;,
            cancel: &#x27;qq-upload-cancel&#x27;,

            // added to list item when upload completes
            // used in css to hide progress spinner
            success: &#x27;qq-upload-success&#x27;,
            fail: &#x27;qq-upload-fail&#x27;
        }
    });
    // overwrite options with user supplied
    qq.extend(this._options, o);

    this._element = this._options.element;
    this._element.innerHTML = this._options.template;
    this._listElement = this._options.listElement || this._find(this._element, &#x27;list&#x27;);

    this._classes = this._options.classes;

    this._button = this._createUploadButton(this._find(this._element, &#x27;button&#x27;));

    this._bindCancelEvent();
    this._setupDragDrop();
};

// inherit from Basic Uploader
qq.extend(qq.FileUploader.prototype, qq.FileUploaderBasic.prototype);

qq.extend(qq.FileUploader.prototype, {
    /**
     * Gets one of the elements listed in this._options.classes
     **/
    _find: function(parent, type){
        var element = qq.getByClass(parent, this._options.classes[type])[0];
        if (!element){
            throw new Error(&#x27;element not found &#x27; + type);
        }

        return element;
    },
    _setupDragDrop: function(){
        var self = this,
            dropArea = this._find(this._element, &#x27;drop&#x27;);

        var dz = new qq.UploadDropZone({
            element: dropArea,
            onEnter: function(e){
                qq.addClass(dropArea, self._classes.dropActive);
                e.stopPropagation();
            },
            onLeave: function(e){
                e.stopPropagation();
            },
            onLeaveNotDescendants: function(e){
                qq.removeClass(dropArea, self._classes.dropActive);
            },
            onDrop: function(e){
                dropArea.style.display = &#x27;none&#x27;;
                qq.removeClass(dropArea, self._classes.dropActive);
                self._uploadFileList(e.dataTransfer.files);
            }
        });

        dropArea.style.display = &#x27;none&#x27;;

        qq.attach(document, &#x27;dragenter&#x27;, function(e){
            if (!dz._isValidFileDrag(e)) return;

            dropArea.style.display = &#x27;block&#x27;;
        });
        qq.attach(document, &#x27;dragleave&#x27;, function(e){
            if (!dz._isValidFileDrag(e)) return;

            var relatedTarget = document.elementFromPoint(e.clientX, e.clientY);
            // only fire when leaving document out
            if ( ! relatedTarget || relatedTarget.nodeName == &quot;HTML&quot;){
                dropArea.style.display = &#x27;none&#x27;;
            }
        });
    },
    _onSubmit: function(id, fileName){
        qq.FileUploaderBasic.prototype._onSubmit.apply(this, arguments);
        this._addToList(id, fileName);
    },
    _onProgress: function(id, fileName, loaded, total){
        qq.FileUploaderBasic.prototype._onProgress.apply(this, arguments);

        var item = this._getItemByFileId(id);
        var size = this._find(item, &#x27;size&#x27;);
        var percent_load = Math.round(loaded / total * 100);

        size.style.display = &#x27;block&#x27;;

        var text;
        if (loaded != total){
            if(percent_load &lt; 50) {
              /* Move the label to the right side of the bar */
              text =  &#x27;&lt;span style=&quot;width: &#x27;+ percent_load +&#x27;%&quot; class=&quot;wpp_upload_progress&quot;&gt;&lt;/span&gt;&lt;span class=&quot;wpp_upload_progress_text&quot;&gt;&#x27;+percent_load+&#x27;% of &#x27; + this._formatSize(total) + &#x27;&lt;/span&gt;&#x27;;
            } else {
              /* Move the label to the left side of the bar */
              text =  &#x27;&lt;span style=&quot;width: &#x27;+ percent_load +&#x27;%&quot; class=&quot;wpp_upload_progress&quot;&gt;&lt;span class=&quot;wpp_upload_progress_text&quot;&gt;&#x27;+percent_load+&#x27;% of &#x27; + this._formatSize(total) + &#x27;&lt;/span&gt;&lt;/span&gt;&#x27;;
            }
        } else {
            text = this._formatSize(total);
        }

        qq.setText(size, text);
    },
    _onComplete: function(id, fileName, result){
        qq.FileUploaderBasic.prototype._onComplete.apply(this, arguments);

        // mark completed
        var item = this._getItemByFileId(id);
        qq.remove(this._find(item, &#x27;cancel&#x27;));
        qq.remove(this._find(item, &#x27;spinner&#x27;));

        if (result.success){
            qq.addClass(item, this._classes.success);
        } else {
            qq.addClass(item, this._classes.fail);
        }
    },
    _addToList: function(id, fileName){
        var item = qq.toElement(this._options.fileTemplate);
        item.qqFileId = id;

        var fileElement = this._find(item, &#x27;file&#x27;);
        qq.setText(fileElement, wpp.strings.uploading+&#x27;: &#x27; +  this._formatFileName(fileName));
        this._find(item, &#x27;size&#x27;).style.display = &#x27;none&#x27;;

        this._listElement.appendChild(item);
    },
    _getItemByFileId: function(id){
        var item = this._listElement.firstChild;

        // there can&#x27;t be txt nodes in dynamically created list
        // and we can  use nextSibling
        while (item){
            if (item.qqFileId == id) return item;
            item = item.nextSibling;
        }
    },
    /**
     * delegate click event for cancel link
     **/
    _bindCancelEvent: function(){
        var self = this,
            list = this._listElement;

        qq.attach(list, &#x27;click&#x27;, function(e){
            e = e || window.event;
            var target = e.target || e.srcElement;

            if (qq.hasClass(target, self._classes.cancel)){
                qq.preventDefault(e);

                var item = target.parentNode;
                self._handler.cancel(item.qqFileId);
                qq.remove(item);
            }
        });
    }
});

qq.UploadDropZone = function(o){
    this._options = {
        element: null,
        onEnter: function(e){},
        onLeave: function(e){},
        // is not fired when leaving element by hovering descendants
        onLeaveNotDescendants: function(e){},
        onDrop: function(e){}
    };
    qq.extend(this._options, o);

    this._element = this._options.element;

    this._disableDropOutside();
    this._attachEvents();
};

qq.UploadDropZone.prototype = {
    _disableDropOutside: function(e){
        // run only once for all instances
        if (!qq.UploadDropZone.dropOutsideDisabled ){

            qq.attach(document, &#x27;dragover&#x27;, function(e){
                if (e.dataTransfer){
                    e.dataTransfer.dropEffect = &#x27;none&#x27;;
                    e.preventDefault();
                }
            });

            qq.UploadDropZone.dropOutsideDisabled = true;
        }
    },
    _attachEvents: function(){
        var self = this;

        qq.attach(self._element, &#x27;dragover&#x27;, function(e){
            if (!self._isValidFileDrag(e)) return;

            var effect = e.dataTransfer.effectAllowed;
            if (effect == &#x27;move&#x27; || effect == &#x27;linkMove&#x27;){
                e.dataTransfer.dropEffect = &#x27;move&#x27;; // for FF (only move allowed)
            } else {
                e.dataTransfer.dropEffect = &#x27;copy&#x27;; // for Chrome
            }

            e.stopPropagation();
            e.preventDefault();
        });

        qq.attach(self._element, &#x27;dragenter&#x27;, function(e){
            if (!self._isValidFileDrag(e)) return;

            self._options.onEnter(e);
        });

        qq.attach(self._element, &#x27;dragleave&#x27;, function(e){
            if (!self._isValidFileDrag(e)) return;

            self._options.onLeave(e);

            var relatedTarget = document.elementFromPoint(e.clientX, e.clientY);
            // do not fire when moving a mouse over a descendant
            if (qq.contains(this, relatedTarget)) return;

            self._options.onLeaveNotDescendants(e);
        });

        qq.attach(self._element, &#x27;drop&#x27;, function(e){
            if (!self._isValidFileDrag(e)) return;

            e.preventDefault();
            self._options.onDrop(e);
        });
    },
    _isValidFileDrag: function(e){
        var dt = e.dataTransfer,
            // do not check dt.types.contains in webkit, because it crashes safari 4
            isWebkit = navigator.userAgent.indexOf(&quot;AppleWebKit&quot;) &gt; -1;

        // dt.effectAllowed is none in Safari 5
        // dt.types.contains check is for firefox
        return dt &amp;&amp; dt.effectAllowed != &#x27;none&#x27; &amp;&amp;
            (dt.files || (!isWebkit &amp;&amp; dt.types.contains &amp;&amp; dt.types.contains(&#x27;Files&#x27;)));

    }
};

qq.UploadButton = function(o){
    this._options = {
        element: null,
        // if set to true adds multiple attribute to file input
        multiple: false,
        // name attribute of file input
        name: &#x27;file&#x27;,
        onChange: function(input){},
        hoverClass: &#x27;qq-upload-button-hover&#x27;,
        focusClass: &#x27;qq-upload-button-focus&#x27;
    };

    qq.extend(this._options, o);

    this._element = this._options.element;

    // make button suitable container for input
    qq.css(this._element, {
        position: &#x27;relative&#x27;,
        overflow: &#x27;hidden&#x27;,
        // Make sure browse button is in the right side
        // in Internet Explorer
        direction: &#x27;ltr&#x27;
    });

    this._input = this._createInput();
};

qq.UploadButton.prototype = {
    /* returns file input element */
    getInput: function(){
        return this._input;
    },
    /* cleans/recreates the file input */
    reset: function(){
        if (this._input.parentNode){
            qq.remove(this._input);
        }

        qq.removeClass(this._element, this._options.focusClass);
        this._input = this._createInput();
    },
    _createInput: function(){
        var input = document.createElement(&quot;input&quot;);

        if (this._options.multiple){
            input.setAttribute(&quot;multiple&quot;, &quot;multiple&quot;);
        }

        input.setAttribute(&quot;type&quot;, &quot;file&quot;);
        input.setAttribute(&quot;name&quot;, this._options.name);

        qq.css(input, {
            position: &#x27;absolute&#x27;,
            // in Opera only &#x27;browse&#x27; button
            // is clickable and it is located at
            // the right side of the input
            right: 0,
            top: 0,
            fontFamily: &#x27;Arial&#x27;,
            // 4 persons reported this, the max values that worked for them were 243, 236, 236, 118
            fontSize: &#x27;118px&#x27;,
            margin: 0,
            padding: 0,
            cursor: &#x27;pointer&#x27;,
            opacity: 0
        });

        this._element.appendChild(input);

        var self = this;
        qq.attach(input, &#x27;change&#x27;, function(){
            self._options.onChange(input);
        });

        qq.attach(input, &#x27;mouseover&#x27;, function(){
            qq.addClass(self._element, self._options.hoverClass);
        });
        qq.attach(input, &#x27;mouseout&#x27;, function(){
            qq.removeClass(self._element, self._options.hoverClass);
        });
        qq.attach(input, &#x27;focus&#x27;, function(){
            qq.addClass(self._element, self._options.focusClass);
        });
        qq.attach(input, &#x27;blur&#x27;, function(){
            qq.removeClass(self._element, self._options.focusClass);
        });

        // IE and Opera, unfortunately have 2 tab stops on file input
        // which is unacceptable in our case, disable keyboard access
        if (window.attachEvent){
            // it is IE or Opera
            input.setAttribute(&#x27;tabIndex&#x27;, &quot;-1&quot;);
        }

        return input;
    }
};

/**
 * Class for uploading files, uploading itself is handled by child classes
 */
qq.UploadHandlerAbstract = function(o){
    this._options = {
        debug: false,
        action: &#x27;/upload.php&#x27;,
        // maximum number of concurrent uploads
        maxConnections: 999,
        onProgress: function(id, fileName, loaded, total){},
        onComplete: function(id, fileName, response){},
        onCancel: function(id, fileName){}
    };
    qq.extend(this._options, o);

    this._queue = [];
    // params for files in queue
    this._params = [];
};
qq.UploadHandlerAbstract.prototype = {
    log: function(str){
        if (this._options.debug &amp;&amp; window.console) console.log(&#x27;[uploader] &#x27; + str);
    },
    /**
     * Adds file or file input to the queue
     * @returns id
     **/
    add: function(file){},
    /**
     * Sends the file identified by id and additional query params to the server
     */
    upload: function(id, params){
        var len = this._queue.push(id);

        var copy = {};
        qq.extend(copy, params);
        this._params[id] = copy;

        // if too many active uploads, wait...
        if (len &lt;= this._options.maxConnections){
            this._upload(id, this._params[id]);
        }
    },
    /**
     * Cancels file upload by id
     */
    cancel: function(id){
        this._cancel(id);
        this._dequeue(id);
    },
    /**
     * Cancells all uploads
     */
    cancelAll: function(){
        for (var i=0; i&lt;this._queue.length; i++){
            this._cancel(this._queue[i]);
        }
        this._queue = [];
    },
    /**
     * Returns name of the file identified by id
     */
    getName: function(id){},
    /**
     * Returns size of the file identified by id
     */
    getSize: function(id){},
    /**
     * Returns id of files being uploaded or
     * waiting for their turn
     */
    getQueue: function(){
        return this._queue;
    },
    /**
     * Actual upload method
     */
    _upload: function(id){},
    /**
     * Actual cancel method
     */
    _cancel: function(id){},
    /**
     * Removes element from queue, starts upload of next
     */
    _dequeue: function(id){
        var i = qq.indexOf(this._queue, id);
        this._queue.splice(i, 1);

        var max = this._options.maxConnections;

        if (this._queue.length &gt;= max &amp;&amp; i &lt; max){
            var nextId = this._queue[max-1];
            this._upload(nextId, this._params[nextId]);
        }
    }
};

/**
 * Class for uploading files using form and iframe
 * @inherits qq.UploadHandlerAbstract
 */
qq.UploadHandlerForm = function(o){
    qq.UploadHandlerAbstract.apply(this, arguments);

    this._inputs = {};
};
// @inherits qq.UploadHandlerAbstract
qq.extend(qq.UploadHandlerForm.prototype, qq.UploadHandlerAbstract.prototype);

qq.extend(qq.UploadHandlerForm.prototype, {
    add: function(fileInput){
        fileInput.setAttribute(&#x27;name&#x27;, &#x27;qqfile&#x27;);
        var id = &#x27;qq-upload-handler-iframe&#x27; + qq.getUniqueId();

        this._inputs[id] = fileInput;

        // remove file input from DOM
        if (fileInput.parentNode){
            qq.remove(fileInput);
        }

        return id;
    },
    getName: function(id){
        // get input value and remove path to normalize
        return this._inputs[id].value.replace(/.*(\/|\\)/, &quot;&quot;);
    },
    _cancel: function(id){
        this._options.onCancel(id, this.getName(id));

        delete this._inputs[id];

        var iframe = document.getElementById(id);
        if (iframe){
            // to cancel request set src to something else
            // we use src=&quot;javascript:false;&quot; because it doesn&#x27;t
            // trigger ie6 prompt on https
            iframe.setAttribute(&#x27;src&#x27;, &#x27;javascript:false;&#x27;);

            qq.remove(iframe);
        }
    },
    _upload: function(id, params){
        var input = this._inputs[id];

        if (!input){
            throw new Error(&#x27;file with passed id was not added, or already uploaded or cancelled&#x27;);
        }

        var fileName = this.getName(id);

        params[&#x27;qqfile&#x27;] = fileName;

        var iframe = this._createIframe(id);
        var form = this._createForm(iframe, params);
        form.appendChild(input);

        var self = this;
        this._attachLoadEvent(iframe, function(){
            self.log(&#x27;iframe loaded&#x27;);

            var response = self._getIframeContentJSON(iframe);

            self._options.onComplete(id, fileName, response);
            self._dequeue(id);

            delete self._inputs[id];
            // timeout added to fix busy state in FF3.6
            setTimeout(function(){
                qq.remove(iframe);
            }, 1);
        });


        form.submit();
        qq.remove(form);

        return id;
    },
    _attachLoadEvent: function(iframe, callback){
        qq.attach(iframe, &#x27;load&#x27;, function(){
            // when we remove iframe from dom
            // the request stops, but in IE load
            // event fires
            if (!iframe.parentNode){
                return;
            }

            // fixing Opera 10.53
            if (iframe.contentDocument &amp;&amp;
                iframe.contentDocument.body &amp;&amp;
                iframe.contentDocument.body.innerHTML == &quot;false&quot;){
                // In Opera event is fired second time
                // when body.innerHTML changed from false
                // to server response approx. after 1 sec
                // when we upload file with iframe
                return;
            }

            callback();
        });
    },
    /**
     * Returns json object received by iframe from server.
     */
    _getIframeContentJSON: function(iframe){
        // iframe.contentWindow.document - for IE&lt;7
        var doc = iframe.contentDocument ? iframe.contentDocument: iframe.contentWindow.document,
            response;

        this.log(&quot;converting iframe&#x27;s innerHTML to JSON&quot;);
        this.log(&quot;innerHTML = &quot; + doc.body.innerHTML);

        try {
            response = eval(&quot;(&quot; + doc.body.innerHTML + &quot;)&quot;);
        } catch(err){
            response = {};
        }

        return response;
    },
    /**
     * Creates iframe with unique name
     */
    _createIframe: function(id){
        // We can&#x27;t use following code as the name attribute
        // won&#x27;t be properly registered in IE6, and new window
        // on form submit will open
        // var iframe = document.createElement(&#x27;iframe&#x27;);
        // iframe.setAttribute(&#x27;name&#x27;, id);

        var iframe = qq.toElement(&#x27;&lt;iframe src=&quot;javascript:false;&quot; name=&quot;&#x27; + id + &#x27;&quot; /&gt;&#x27;);
        // src=&quot;javascript:false;&quot; removes ie6 prompt on https

        iframe.setAttribute(&#x27;id&#x27;, id);

        iframe.style.display = &#x27;none&#x27;;
        document.body.appendChild(iframe);

        return iframe;
    },
    /**
     * Creates form, that will be submitted to iframe
     */
    _createForm: function(iframe, params){
        // We can&#x27;t use the following code in IE6
        // var form = document.createElement(&#x27;form&#x27;);
        // form.setAttribute(&#x27;method&#x27;, &#x27;post&#x27;);
        // form.setAttribute(&#x27;enctype&#x27;, &#x27;multipart/form-data&#x27;);
        // Because in this case file won&#x27;t be attached to request
        var form = qq.toElement(&#x27;&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;&lt;/form&gt;&#x27;);

        var queryString = qq.obj2url(params, this._options.action);

        form.setAttribute(&#x27;action&#x27;, queryString);
        form.setAttribute(&#x27;target&#x27;, iframe.name);
        form.style.display = &#x27;none&#x27;;
        document.body.appendChild(form);

        return form;
    }
});

/**
 * Class for uploading files using xhr
 * @inherits qq.UploadHandlerAbstract
 */
qq.UploadHandlerXhr = function(o){
    qq.UploadHandlerAbstract.apply(this, arguments);

    this._files = [];
    this._xhrs = [];

    // current loaded size in bytes for each file
    this._loaded = [];
};

// static method
qq.UploadHandlerXhr.isSupported = function(){
    var input = document.createElement(&#x27;input&#x27;);
    input.type = &#x27;file&#x27;;

    return (
        &#x27;multiple&#x27; in input &amp;&amp;
        typeof File != &quot;undefined&quot; &amp;&amp;
        typeof (new XMLHttpRequest()).upload != &quot;undefined&quot; );
};

// @inherits qq.UploadHandlerAbstract
qq.extend(qq.UploadHandlerXhr.prototype, qq.UploadHandlerAbstract.prototype)

qq.extend(qq.UploadHandlerXhr.prototype, {
    /**
     * Adds file to the queue
     * Returns id to use with upload, cancel
     **/
    add: function(file){
        if (!(file instanceof File)){
            throw new Error(&#x27;Passed obj in not a File (in qq.UploadHandlerXhr)&#x27;);
        }

        return this._files.push(file) - 1;
    },
    getName: function(id){
        var file = this._files[id];
        // fix missing name in Safari 4
        return file.fileName != null ? file.fileName : file.name;
    },
    getSize: function(id){
        var file = this._files[id];
        return file.fileSize != null ? file.fileSize : file.size;
    },
    /**
     * Returns uploaded bytes for file identified by id
     */
    getLoaded: function(id){
        return this._loaded[id] || 0;
    },
    /**
     * Sends the file identified by id and additional query params to the server
     * @param {Object} params name-value string pairs
     */
    _upload: function(id, params){
        var file = this._files[id],
            name = this.getName(id),
            size = this.getSize(id);

        this._loaded[id] = 0;

        var xhr = this._xhrs[id] = new XMLHttpRequest();
        var self = this;

        xhr.upload.onprogress = function(e){
            if (e.lengthComputable){
                self._loaded[id] = e.loaded;
                self._options.onProgress(id, name, e.loaded, e.total);
            }
        };

        xhr.onreadystatechange = function(){
            if (xhr.readyState == 4){
                self._onComplete(id, xhr);
            }
        };

        // build query string
        params = params || {};
        params[&#x27;qqfile&#x27;] = name;
        var queryString = qq.obj2url(params, this._options.action);

        xhr.open(&quot;POST&quot;, queryString, true);
        xhr.setRequestHeader(&quot;X-Requested-With&quot;, &quot;XMLHttpRequest&quot;);
        xhr.setRequestHeader(&quot;X-File-Name&quot;, encodeURIComponent(name));
        xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;application/octet-stream&quot;);
        xhr.send(file);
    },
    _onComplete: function(id, xhr){
        // the request was aborted/cancelled
        if (!this._files[id]) return;

        var name = this.getName(id);
        var size = this.getSize(id);

        this._options.onProgress(id, name, size, size);

        if (xhr.status == 200){
            this.log(&quot;xhr - server response received&quot;);
            this.log(&quot;responseText = &quot; + xhr.responseText);

            var response;

            try {
                response = eval(&quot;(&quot; + xhr.responseText + &quot;)&quot;);
            } catch(err){
                response = {};
            }

            this._options.onComplete(id, name, response);

        } else {
            this._options.onComplete(id, name, {});
        }

        this._files[id] = null;
        this._xhrs[id] = null;
        this._dequeue(id);
    },
    _cancel: function(id){
        this._options.onCancel(id, this.getName(id));

        this._files[id] = null;

        if (this._xhrs[id]){
            this._xhrs[id].abort();
            this._xhrs[id] = null;
        }
    }
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
